import telebot
import sqlite3
import time
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
BOT_TOKEN = "7547663858:AAGOC_rmsGMb2gNT-wnC9qa_F5NBXH3iyUc"
bot = telebot.TeleBot(BOT_TOKEN)

# Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
conn = sqlite3.connect("mining_bot.db", check_same_thread=False)
cursor = conn.cursor()

# Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
cursor.execute("""
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY,
    username TEXT,
    balance REAL DEFAULT 0,
    last_mined INTEGER DEFAULT 0
)
""")
conn.commit()

# Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
def register_user(user_id, username): 
    cursor.execute("SELECT id FROM users WHERE id = ?", (user_id,))
    if cursor.fetchone() is None:
        cursor.execute("INSERT INTO users (id, username) VALUES (?, ?)", (user_id, username))
        conn.commit()

# Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
def mine_coins(user_id):
    cursor.execute("SELECT last_mined, balance FROM users WHERE id = ?", (user_id,))
    user = cursor.fetchone()
    if user:
        last_mined, balance = user
        current_time = int(time.time())
        if current_time - last_mined >= 60:  # Ø§Ù„ØªØ¹Ø¯ÙŠÙ† ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
            new_balance = balance + 0.01  # Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
            cursor.execute("UPDATE users SET balance = ?, last_mined = ? WHERE id = ?", 
                           (new_balance, current_time, user_id))
            conn.commit()
            return True, new_balance
        else:
            return False, balance
    return None, 0

# Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯
def get_balance(user_id):
    cursor.execute("SELECT balance FROM users WHERE id = ?", (user_id,))
    user = cursor.fetchone()
    return user[0] if user else 0

# Ø¯Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
@bot.message_handler(commands=["start"])
def start_message(message):
    user_id = message.chat.id
    username = message.chat.username or "Unknown"
    register_user(user_id, username)
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ðŸ’Ž Mine Coins", callback_data="mine"))
    markup.add(InlineKeyboardButton("ðŸ’° My Balance", callback_data="balance"))
    bot.send_message(user_id, "Welcome to the Mining Bot! Choose an option below:", reply_markup=markup)

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
@bot.callback_query_handler(func=lambda call: True)
def handle_query(call):
    user_id = call.message.chat.id
    if call.data == "mine":
        success, balance = mine_coins(user_id)
        if success:
            bot.answer_callback_query(call.id, "You mined 0.01 coin! ðŸŽ‰")
        else:
            bot.answer_callback_query(call.id, "You need to wait before mining again.")
    elif call.data == "balance":
        balance = get_balance(user_id)
        bot.answer_callback_query(call.id, f"Your balance: {balance:.2f} coins ðŸ’°")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot.polling()
